<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <title>Local ChatGPT - Ollama</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background-color: #0f0f0f; }
    .chat-bubble { white-space: pre-wrap; }
    
    /* Typing dots */
    .typing-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin-right: 4px;
      background-color: #6cf58a;
      border-radius: 50%;
      animation: blink 1s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0% { opacity: 0.2; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-3px); }
      100% { opacity: 0.2; transform: translateY(0); }
    }
  </style>
</head>

<body class="dark:bg-[#0f0f0f] dark:text-white flex flex-col h-screen">

<!-- HEADER -->
<header class="p-4 bg-[#1e1e1e] border-b border-gray-700 flex items-center justify-between">

  <div class="flex items-center space-x-4">
    <h1 class="text-xl font-semibold text-white">Local ChatGPT (Ollama)</h1>

    <!-- MODEL DROPDOWN -->
    <select id="model-select" class="bg-[#2b2b2b] text-white px-3 py-2 rounded-lg border border-gray-600">
      <option>Loading...</option>
    </select>
  </div>

  <div class="flex space-x-3">
    <input type="file" id="pdf-input" class="hidden" accept="application/pdf" />
    <button id="upload-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-500">
      Upload PDF
    </button>

    <button id="clear-chat" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-500">
      Clear Chat
    </button>
  </div>

</header>

<!-- CHAT WINDOW -->
<div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

<!-- FOOTER -->
<footer class="p-4 bg-[#1e1e1e] border-t border-gray-700">

  <div class="mb-3">
    <button id="ask-pdf-btn" class="px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-500">
      Ask from PDF
    </button>
  </div>
  <a href="/embedding_explorer" 
   class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-500">
   Embedding Explorer
</a>

  <div class="flex space-x-3">
    <input id="message"
      class="flex-1 p-3 bg-[#2b2b2b] border border-gray-600 rounded-lg focus:outline-none"
      placeholder="Type your message..." />

    <button id="send-btn"
      class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-500">
      Send
    </button>
  </div>
</footer>

<script>
const chatBox = document.getElementById("chat-box");
const msgBox = document.getElementById("message");
const sendBtn = document.getElementById("send-btn");
const clearBtn = document.getElementById("clear-chat");
const uploadBtn = document.getElementById("upload-btn");
const pdfInput = document.getElementById("pdf-input");
const askPdfBtn = document.getElementById("ask-pdf-btn");

let pdfMode = false;
let autoScroll = true;

// -----------------------
// MODEL SELECTION
// -----------------------
const modelSelect = document.getElementById("model-select");

async function loadModels() {
  const res = await fetch("/models");
  const data = await res.json();

  modelSelect.innerHTML = "";

  data.models.forEach(model => {
    const option = document.createElement("option");
    option.value = model;
    option.textContent = model;
    modelSelect.appendChild(option);
  });

  const savedModel = localStorage.getItem("selectedModel");
  if (savedModel && data.models.includes(savedModel)) {
    modelSelect.value = savedModel;
    await setModel(savedModel);
  }
}

async function setModel(model) {
  await fetch("/set_model", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ model })
  });

  localStorage.setItem("selectedModel", model);
  clearHistory();
}

modelSelect.onchange = async () => {
  await setModel(modelSelect.value);
  alert("Model changed to " + modelSelect.value);
};

// -----------------------
// CHAT HISTORY
// -----------------------
function saveHistory() {
  localStorage.setItem("chatHistory", chatBox.innerHTML);
}

function loadHistory() {
  const saved = localStorage.getItem("chatHistory");
  if (saved) chatBox.innerHTML = saved;
}

function clearHistory() {
  localStorage.removeItem("chatHistory");
  chatBox.innerHTML = "";
}

loadHistory();

// -----------------------
// AUTO SCROLL
// -----------------------
chatBox.addEventListener("scroll", () => {
  const nearBottom = chatBox.scrollHeight - chatBox.scrollTop <= chatBox.clientHeight + 50;
  autoScroll = nearBottom;
});

function smartScroll() {
  if (autoScroll) {
    chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });
  }
}

// -----------------------
// CHAT BUBBLES
// -----------------------
function addBubble(role, text) {
  const div = document.createElement("div");

  if (role === "user") {
    div.className = "chat-bubble max-w-xl ml-auto bg-blue-600 text-white p-3 rounded-xl";
  } else {
    div.className = "chat-bubble max-w-xl mr-auto bg-[#2f2f2f] text-green-300 p-3 rounded-xl";
  }

  div.innerText = text;
  chatBox.appendChild(div);
  smartScroll();
  saveHistory();
}

// -----------------------
// TYPING INDICATOR
// -----------------------
function showTyping() {
  const div = document.createElement("div");
  div.id = "typingIndicator";
  div.className =
    "chat-bubble max-w-xs mr-auto bg-[#2f2f2f] text-green-300 p-3 rounded-xl flex space-x-1";

  div.innerHTML = `
    <span class="typing-dot"></span>
    <span class="typing-dot"></span>
    <span class="typing-dot"></span>
  `;

  chatBox.appendChild(div);
  smartScroll();
  saveHistory();
}

function removeTyping() {
  const t = document.getElementById("typingIndicator");
  if (t) t.remove();
  saveHistory();
}

// -----------------------
// CLEAR CHAT
// -----------------------
clearBtn.onclick = () => {
  clearHistory();
  fetch("/clear", { method: "POST" });
};

// -----------------------
// PDF UPLOAD
// -----------------------
uploadBtn.onclick = () => pdfInput.click();

pdfInput.onchange = async () => {
  const file = pdfInput.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);

  addBubble("llm", "ðŸ“„ Processing PDF...");

  const res = await fetch("/upload_pdf", {
    method: "POST",
    body: formData
  });

  const data = await res.json();
  addBubble("llm", `PDF processed. ${data.chunks} chunks stored.`);
};

// Toggle PDF Q&A
askPdfBtn.onclick = () => {
  pdfMode = !pdfMode;
  askPdfBtn.classList.toggle("bg-purple-800");
  askPdfBtn.innerText = pdfMode ? "PDF Mode ON" : "Ask from PDF";
};

// -----------------------
// SEND MESSAGE
// -----------------------
sendBtn.onclick = async () => {
  let text = msgBox.value.trim();
  if (!text) return;

  addBubble("user", text);
  msgBox.value = "";

  showTyping();

  const response = await fetch(pdfMode ? "/ask_pdf" : "/chat", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ message: text })
  });

  removeTyping();

  // Streaming response
  let reader = response.body.getReader();
  let decoder = new TextDecoder();

  let llmText = "";
  let bubble = document.createElement("div");
  bubble.className =
    "chat-bubble max-w-xl mr-auto bg-[#2f2f2f] text-green-300 p-3 rounded-xl";
  bubble.innerText = "";
  chatBox.appendChild(bubble);

  while (true) {
    const { value, done } = await reader.read();
    if (done) break;

    let chunk = decoder.decode(value);
    llmText += chunk;
    bubble.innerText = llmText;

    smartScroll();
    saveHistory();
  }
};

// Init
loadModels();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>Local ChatGPT - Ollama</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background-color: #0f0f0f; }
    .chat-bubble { white-space: pre-wrap; }
    .typing-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin-right: 4px;
      background-color: #6cf58a;
      border-radius: 50%;
      animation: blink 1s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0% { opacity: 0.2; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-3px); }
      100% { opacity: 0.2; transform: translateY(0); }
    }
  </style>
</head>

<body class="dark:bg-[#0f0f0f] dark:text-white flex flex-col h-screen">

<!-- HEADER -->
<header class="p-4 bg-[#1e1e1e] border-b border-gray-700 flex items-center justify-between">
  <div class="flex items-center space-x-4">
    <h1 class="text-xl font-semibold text-white">Local ChatGPT (Ollama)</h1>

    <select id="model-select"
      class="bg-[#2b2b2b] text-white px-3 py-2 rounded-lg border border-gray-600">
      <option>Loading...</option>
    </select>
  </div>

  <div class="flex space-x-3">
    <input type="file" id="pdf-input" class="hidden" accept="application/pdf" />
    <button id="upload-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-500">
      Upload PDF
    </button>

    <button id="clear-chat" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-500">
      Clear Chat
    </button>
  </div>
</header>

<!-- LAYOUT -->
<div class="flex flex-1 h-full">

  <!-- SIDEBAR -->
  <aside class="w-72 bg-[#1b1b1b] border-r border-gray-700 p-4 overflow-y-auto">
    <h2 class="text-lg font-semibold mb-3 text-white">üìö Uploaded PDFs</h2>

    <div class="flex justify-between mb-3">
      <button id="selectAllBtn" class="text-sm text-blue-400 hover:underline">
        Select All
      </button>
      <button id="deselectAllBtn" class="text-sm text-blue-400 hover:underline">
        Clear
      </button>
    </div>

    <div id="pdfList" class="space-y-4 text-gray-300">
      <p class="text-gray-500">No PDFs uploaded yet.</p>
    </div>

  </aside>

  <!-- CHAT AREA -->
  <div class="flex flex-col flex-1">

    <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

    <!-- FOOTER -->
    <footer class="p-4 bg-[#1e1e1e] border-t border-gray-700 flex-shrink-0">

      <div class="mb-3 flex space-x-3">
        <button id="ask-pdf-btn"
          class="px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-500">
          Ask from Selected PDFs
        </button>

        <a href="/embedding_explorer"
          class="px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-500">
          Embedding Explorer
        </a>
      </div>

      <div class="flex space-x-3">
        <input id="message"
          class="flex-1 p-3 bg-[#2b2b2b] border border-gray-600 rounded-lg focus:outline-none"
          placeholder="Type your message..." />

        <button id="send-btn"
          class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-500">
          Send
        </button>
      </div>

    </footer>
    <!-- PDF VIEWER PANEL -->
<div id="pdfViewerPanel"
     class="fixed right-0 top-0 h-full w-[420px] bg-black border-l border-gray-700 hidden flex-col">

  <div class="p-3 flex justify-between items-center bg-[#1e1e1e] border-b border-gray-700">
    <h2 class="text-lg font-semibold">üìÑ PDF Viewer</h2>
    <button id="closePdfViewer" class="text-red-400 hover:text-red-300">‚úñ</button>
  </div>

  <iframe id="pdfFrame"
          class="flex-1 w-full"
          src=""
          style="height: calc(100% - 50px);"></iframe>
</div>

  </div>
</div>


<script>
const chatBox = document.getElementById("chat-box");
const msgBox = document.getElementById("message");
const sendBtn = document.getElementById("send-btn");
const clearBtn = document.getElementById("clear-chat");
const uploadBtn = document.getElementById("upload-btn");
const pdfInput = document.getElementById("pdf-input");
const pdfList = document.getElementById("pdfList");
const askPdfBtn = document.getElementById("ask-pdf-btn");

let selectedDocs = [];   
let pdfMode = false;

const pdfViewer = document.getElementById("pdfViewerPanel");
const pdfFrame = document.getElementById("pdfFrame");
const closePdfViewer = document.getElementById("closePdfViewer");

function openPdfViewer(docId, page) {
  pdfViewer.classList.remove("hidden");

  // Load PDF + jump to specific page
  pdfFrame.src = `/uploaded_pdfs/${docId}#page=${page}`;
}

closePdfViewer.onclick = () => {
  pdfViewer.classList.add("hidden");
};


// -----------------------------
// ADD PDF TO SIDEBAR
// -----------------------------
function addPdfToSidebar(fileName, chunks) {
  if (pdfList.children[0]?.innerText.includes("No PDFs")) {
    pdfList.innerHTML = "";
  }

  const wrapper = document.createElement("div");
  wrapper.className =
    "relative p-3 bg-[#252525] rounded-lg border border-gray-700 shadow-sm";

  wrapper.innerHTML = `
    <label class="flex items-start space-x-3 cursor-pointer">

      <input type="checkbox"
             class="pdf-checkbox h-5 w-5 mt-1"
             value="${fileName}">

      <div class="flex-1">
        <img src="/pdf_thumbnail/${fileName}"
             class="w-full h-28 object-cover rounded border border-gray-700 mb-2" />

        <div class="text-white font-semibold">${fileName}</div>
        <div class="text-sm text-gray-400">${chunks} chunks</div>
      </div>
    </label>

    <button class="absolute top-2 right-2 text-red-400 hover:text-red-300 delete-btn"
            data-doc="${fileName}">
      üóë
    </button>
  `;

  pdfList.appendChild(wrapper);

  wrapper.querySelector(".delete-btn").onclick = () => deletePdf(fileName);

  updateSelected();
}

async function deletePdf(docName) {
  if (!confirm(`Delete ${docName}?`)) return;

  await fetch("/delete_pdf", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ doc_id: docName })
  });

  [...pdfList.children].forEach(div => {
    if (div.innerHTML.includes(docName)) div.remove();
  });

  if (pdfList.children.length === 0) {
    pdfList.innerHTML = `<p class="text-gray-500">No PDFs uploaded yet.</p>`;
  }

  updateSelected();
}

function updateSelected() {
  selectedDocs = [...document.querySelectorAll(".pdf-checkbox:checked")]
    .map(cb => cb.value);

  askPdfBtn.innerText =
    selectedDocs.length > 0
      ? `Ask (${selectedDocs.length} PDFs)`
      : "Ask from Selected PDFs";
}


// -----------------------------
// MODEL DROPDOWN
// -----------------------------
const modelSelect = document.getElementById("model-select");

async function loadModels() {
  const res = await fetch("/models");
  const data = await res.json();

  modelSelect.innerHTML = "";

  data.models.forEach(model => {
    const option = document.createElement("option");
    option.value = model;
    option.textContent = model;
    modelSelect.appendChild(option);
  });
}

modelSelect.onchange = async () => {
  await fetch("/set_model", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ model: modelSelect.value })
  });
};


// -----------------------------
// CHAT BUBBLES
// -----------------------------
function addBubble(role, text) {
  const div = document.createElement("div");

  div.className =
    role === "user"
      ? "chat-bubble max-w-xl ml-auto bg-blue-600 text-white p-3 rounded-xl"
      : "chat-bubble max-w-xl mr-auto bg-[#2f2f2f] text-green-300 p-3 rounded-xl";

  div.innerHTML = text.replace(/\n/g, "<br>");
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}


// -----------------------------
// TYPING INDICATOR
// -----------------------------
function showTyping() {
  const div = document.createElement("div");
  div.id = "typingIndicator";

  div.className =
    "chat-bubble max-w-xs mr-auto bg-[#2f2f2f] text-green-300 p-3 rounded-xl flex space-x-1";

  div.innerHTML = `
    <span class="typing-dot"></span>
    <span class="typing-dot"></span>
    <span class="typing-dot"></span>
  `;

  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function removeTyping() {
  const t = document.getElementById("typingIndicator");
  if (t) t.remove();
}


// -----------------------------
// CLEAR CHAT
// -----------------------------
clearBtn.onclick = () => {
  chatBox.innerHTML = "";
  fetch("/clear", { method: "POST" });
};


// -----------------------------
// PDF UPLOAD
// -----------------------------
uploadBtn.onclick = () => pdfInput.click();

pdfInput.onchange = async () => {
  const file = pdfInput.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);

  addBubble("llm", "üìÑ Processing PDF...");

  const res = await fetch("/upload_pdf", {
    method: "POST",
    body: formData
  });

  const data = await res.json();

  addBubble("llm", `üìÑ ${data.file} uploaded (${data.chunks} chunks)`);

  addPdfToSidebar(data.file, data.chunks);
};


// -----------------------------
// SEND MESSAGE (Chat + RAG)
// -----------------------------
sendBtn.onclick = async () => {
  const text = msgBox.value.trim();
  if (!text) return;

  addBubble("user", text);
  msgBox.value = "";

  showTyping();

  const body = pdfMode
    ? { message: text, selected_docs: selectedDocs }
    : { message: text };

  const response = await fetch(
    pdfMode ? "/ask_pdf" : "/chat",
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    }
  );

  removeTyping();

  let reader = response.body.getReader();
  let decoder = new TextDecoder();

  let llmText = "";
  let bubble = document.createElement("div");
  bubble.className =
    "chat-bubble max-w-xl mr-auto bg-[#2f2f2f] text-green-300 p-3 rounded-xl";
  chatBox.appendChild(bubble);

  // STREAM RESPONSE
  while (true) {
    const { value, done } = await reader.read();
    if (done) break;

    const chunk = decoder.decode(value);
    llmText += chunk;
    bubble.innerHTML = llmText.replace(/\n/g, "<br>");
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // ------------------------------
  // ‚≠ê ADD SOURCE BOX (NEW)
  // ------------------------------
  const sourceHeader = response.headers.get("X-RAG-Sources");
  if (sourceHeader) {
    try {
      const sources = JSON.parse(sourceHeader);

      const srcBox = document.createElement("div");
      srcBox.className =
        "mt-3 p-3 bg-black/30 border border-gray-700 rounded text-gray-300 text-sm";

      let html = `<b>üìÑ Sources Used:</b><br>`;
     sources.forEach((s, i) => {
      html += `
        <button class="text-blue-400 hover:underline source-link"
                data-doc="${s.doc_id}"
                data-page="${s.page}">
          Source ${i+1}: ${s.doc_id} ‚Äî Page ${s.page}
        </button><br>`;
    });;

      srcBox.innerHTML = html;
      bubble.appendChild(srcBox);

      // Enable click ‚Üí open viewer
    srcBox.querySelectorAll(".source-link").forEach(btn => {
      btn.onclick = () => {
        const did = btn.dataset.doc;
        const pg = btn.dataset.page;
        openPdfViewer(did, pg);
      };
    });

    } catch (e) {
      console.log("Source parse error", e);
    }
  }
};


// Toggle PDF mode
askPdfBtn.onclick = () => {
  pdfMode = !pdfMode;
  askPdfBtn.classList.toggle("bg-purple-800");
  askPdfBtn.innerText = pdfMode ? "PDF Mode: ON" : "Ask from Selected PDFs";
};


loadModels();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Embedding Explorer</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js + Matrix Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.3.0"></script>

  <!-- Latest Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

  <style>
    body { background:#0e0e0e; }
    .card { background:#1a1a1a; border:1px solid #2b2b2b; border-radius:12px; padding:20px; }
    .input-box { background:#111; border:1px solid #333; border-radius:8px; padding:12px; width:100%; }
  </style>
</head>

<body class="text-gray-200">

<header class="px-6 py-4 border-b border-gray-800 bg-[#121212] flex justify-between items-center">
  <h1 class="text-2xl font-semibold">Embedding Explorer</h1>
  <a href="/" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500">â† Back</a>
</header>

<div class="flex h-[calc(100vh-70px)]">

  <!-- SIDEBAR -->
  <aside class="w-64 border-r border-gray-800 p-6 bg-[#141414]">
    <nav class="space-y-3">
      <button onclick="showPanel('gen-panel')" class="w-full text-left p-2 rounded hover:bg-gray-800">ğŸ“Œ Generate Embedding</button>
      <button onclick="showPanel('cmp-panel')" class="w-full text-left p-2 rounded hover:bg-gray-800">ğŸ”— Compare</button>
      <button onclick="showPanel('cluster-panel')" class="w-full text-left p-2 rounded hover:bg-gray-800">ğŸ§¬ Cluster</button>
      <button onclick="showPanel('matrix-panel')" class="w-full text-left p-2 rounded hover:bg-gray-800">ğŸ§© Similarity Matrix</button>
    </nav>
  </aside>

  <!-- MAIN AREA -->
  <main class="flex-1 overflow-y-auto p-8 space-y-10">

    <!-- GENERATE -->
    <section id="gen-panel" class="card">
      <h2 class="text-xl mb-3">ğŸ“Œ Generate Embedding</h2>

      <textarea id="embedText" rows="4" class="input-box mb-3" placeholder="Enter text..."></textarea>
      <button id="genBtn" class="px-6 py-3 bg-blue-600 rounded hover:bg-blue-500">Generate</button>

      <div id="loading" class="hidden mt-4 text-green-400">Loading...</div>

      <div id="results" class="hidden mt-5">
        <p>Dimension: <span id="dim"></span></p>
        <p class="mt-2 text-gray-400">Preview:</p>
        <pre id="preview" class="bg-black p-4 rounded"></pre>

        <h3 class="mt-4 text-lg">PCA 2D</h3>
        <canvas id="pcaChart" height="300"></canvas>
      </div>
    </section>

    <!-- COMPARE -->
    <section id="cmp-panel" class="card hidden">
      <h2 class="text-xl mb-3">ğŸ”— Compare Embeddings</h2>

      <div class="grid grid-cols-2 gap-4">
        <textarea id="cmpText1" class="input-box" rows="4"></textarea>
        <textarea id="cmpText2" class="input-box" rows="4"></textarea>
      </div>

      <button id="cmpBtn" class="mt-4 px-6 py-3 bg-purple-600 rounded hover:bg-purple-500">Compare</button>

      <div id="cmpResults" class="hidden mt-6">
        <p>Cosine: <span id="cosSim"></span></p>
        <p>L2: <span id="l2Dist"></span></p>
        <p>Dot Product: <span id="dotProd"></span></p>

        <h3 class="mt-4 text-lg">ğŸ“‰ PCA 2D</h3>
        <canvas id="cmpChart" height="300"></canvas>

        <h3 class="mt-6 text-lg">ğŸ“Š PCA 3D</h3>
        <div id="pca3d" style="width:100%;height:350px;"></div>

        <h3 class="mt-6 text-lg">ğŸ§Š Difference Heatmap</h3>
        <canvas id="heatmapCanvas" height="120"></canvas>

      </div>
    </section>

    <!-- CLUSTER -->
    <section id="cluster-panel" class="card hidden">
      <h2 class="text-xl mb-3">ğŸ§¬ Cluster Embeddings</h2>

      <div class="flex space-x-3 mb-3">
        <input id="clusterK" type="number" value="3" min="2" class="input-box w-32" />
        <button id="clusterBtn" class="px-6 py-3 bg-green-600 rounded hover:bg-green-500">Run</button>
      </div>

      <div id="clusterResults" class="hidden">
        <canvas id="clusterChart" height="320"></canvas>
      </div>
    </section>

    <!-- MATRIX -->
    <section id="matrix-panel" class="card hidden">
      <h2 class="text-xl mb-3">ğŸ§© Cosine Similarity Matrix</h2>

      <button id="matrixBtn" class="px-6 py-3 bg-indigo-600 rounded hover:bg-indigo-500">
        Load Matrix
      </button>

      <div id="matrixVis" class="hidden overflow-auto mt-6">
        <div id="matrixGrid"></div>
      </div>
    </section>

  </main>
</div>

<script>
function showPanel(id) {
  document.querySelectorAll("main section").forEach(s => s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function destroy(chart) {
  if (chart && typeof chart.destroy === "function") chart.destroy();
}

/* --------------------------
    GENERATE EMBEDDING
---------------------------*/
let pcaChart=null;

genBtn.onclick = async () => {
  const text = embedText.value.trim();
  if (!text) return alert("Enter text");

  loading.classList.remove("hidden");
  const res = await fetch("/embed_text", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ text })
  });
  const data = await res.json();
  loading.classList.add("hidden");

  if (data.error) return alert(data.error);

  results.classList.remove("hidden");
  dim.textContent = data.dimension;
  preview.textContent = JSON.stringify(data.vector_preview,null,2);

  destroy(pcaChart);

  const ctx = document.getElementById("pcaChart").getContext("2d");
  pcaChart = new Chart(ctx, {
    type:"scatter",
    data:{ datasets:[{data:[{x:data.pca[0],y:data.pca[1]}], backgroundColor:"#00ff99"}] }
  });
};

/* --------------------------
    FIXED HEATMAP
---------------------------*/
function createHeatmap(canvasId, diffVector) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error("âŒ Heatmap: canvas not found:", canvasId);
        return;
    }

    const ctx = canvas.getContext("2d");

    // SAFE DESTROY â€” only destroy if it's really a Chart.js instance
    if (window[canvasId] && window[canvasId] instanceof Chart) {
        window[canvasId].destroy();
    }

    const maxAbs = Math.max(...diffVector.map(v => Math.abs(v)));

    const defer = {
        id: "deferHeatmap",
        afterLayout(chart) {
            if (!chart.chartArea) return;

            const w = chart.chartArea.width / diffVector.length;
            const h = chart.chartArea.height;

            chart.data.datasets[0].width = diffVector.map(() => w);
            chart.data.datasets[0].height = diffVector.map(() => h);
        }
    };

    window[canvasId] = new Chart(ctx, {
        type: "matrix",
        data: {
            datasets: [{
                label: "Heat",
                data: diffVector.map((v, i) => ({ x: i, y: 0, v })),

                backgroundColor({ raw }) {
                    const a = Math.abs(raw.v) / maxAbs;
                    return raw.v >= 0
                        ? `rgba(0,255,0,${a})`
                        : `rgba(255,0,0,${a})`;
                },

                width: diffVector.map(() => 1),
                height: diffVector.map(() => 1)
            }]
        },
        plugins: [defer],
        options: {
            responsive: true,
            animation: false,
            scales: {
                x: { display: false },
                y: { display: false }
            }
        }
    });
}


/* --------------------------
    COMPARE EMBEDDINGS
---------------------------*/
let cmpChart=null;

cmpBtn.onclick = async () => {
  const t1=cmpText1.value.trim();
  const t2=cmpText2.value.trim();
  if(!t1||!t2)return alert("Enter texts!");

  const res=await fetch("/compare_embeddings",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ text1:t1,text2:t2 })
  });
  const data=await res.json();
  if(data.error)return alert(data.error);

  cmpResults.classList.remove("hidden");

  cosSim.textContent=data.cosine_similarity.toFixed(4);
  l2Dist.textContent=data.l2_distance.toFixed(4);
  dotProd.textContent=data.dot_product.toFixed(4);

  destroy(cmpChart);
  const ctx=document.getElementById("cmpChart").getContext("2d");

  cmpChart=new Chart(ctx,{
    type:"scatter",
    data:{
      datasets:[
        {label:"A",data:[{x:data.pca_points[0][0],y:data.pca_points[0][1]}],backgroundColor:"#00ff99"},
        {label:"B",data:[{x:data.pca_points[1][0],y:data.pca_points[1][1]}],backgroundColor:"#ff6666"}
      ]
    }
  });

  const p3d=await fetch("/pca_3d",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text1:t1,text2:t2})
  });
  const d3=await p3d.json();
  if(!d3.error) show3D(d3.points_3d);

  createHeatmap("heatmapCanvas", data.diff_vector);
};

/* --------------------------
    3D PCA
---------------------------*/
function show3D(points){
  Plotly.newPlot("pca3d",[{
    x:[points[0][0],points[1][0]],
    y:[points[0][1],points[1][1]],
    z:[points[0][2],points[1][2]],
    mode:"markers+lines",
    type:"scatter3d",
    marker:{size:6,color:["#00ff99","#ff6666"]},
    line:{color:"#999"}
  }],{
    scene:{
      xaxis:{title:"PC1"},
      yaxis:{title:"PC2"},
      zaxis:{title:"PC3"},
    },
    paper_bgcolor:"#111",
    plot_bgcolor:"#111"
  });
}

/* --------------------------
    CLUSTER
---------------------------*/
let clusterChart=null;

clusterBtn.onclick=async()=>{
  const k=parseInt(clusterK.value);
  const res=await fetch("/cluster_embeddings",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({k})
  });
  const data=await res.json();
  if(data.error)return alert(data.error);

  clusterResults.classList.remove("hidden");
  destroy(clusterChart);

  const ctx=document.getElementById("clusterChart").getContext("2d");
  clusterChart=new Chart(ctx,{
    type:"scatter",
    data:{
      datasets:Object.keys(data.clusters).map(cid=>({
        label:"Cluster "+cid,
        data:data.pca2d.filter((_,i)=>data.labels[i]==cid).map(pt=>({x:pt[0],y:pt[1]})),
        backgroundColor:`hsl(${cid*90},70%,60%)`
      }))
    }
  });
};

/* --------------------------
    SIMILARITY MATRIX
---------------------------*/
matrixBtn.onclick=async()=>{
  const res=await fetch("/similarity_matrix");
  const data=await res.json();
  if(data.error)return alert(data.error);

  matrixVis.classList.remove("hidden");

  let html="<table class='border-collapse'>";
  html+="<tr><th></th>"+data.labels.map(l=>`<th class='border p-1 text-xs'>${l}</th>`).join("")+"</tr>";

  data.matrix.forEach((row,i)=>{
    html+=`<tr><td class='border p-1 text-xs'>${data.labels[i]}</td>`;
    row.forEach(c=>{
      let v=Math.floor((c+1)*128);
      html+=`<td class='border p-1' style='background:rgb(${v},${v},255);'>${c.toFixed(2)}</td>`;
    });
    html+="</tr>";
  });
  html+="</table>";
  matrixGrid.innerHTML=html;
};
</script>

</body>
</html>
